name: Automated Code Review

on:
  push:
    branches: [ main, develop, 'feature/**', 'bugfix/**', 'hotfix/**' ]
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened]

jobs:
  pre-deployment-checks:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
    
    - name: Cache Maven dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
    
    - name: Compile and Test
      run: |
        mvn clean compile test
    
    - name: Run SpotBugs Analysis
      run: |
        mvn spotbugs:spotbugs
        mvn spotbugs:check
    
    - name: Run PMD Analysis
      run: |
        mvn pmd:pmd pmd:check
    
    - name: Security Scan with OWASP
      run: |
        mvn org.owasp:dependency-check-maven:check
    
    - name: Check Code Coverage
      run: |
        mvn jacoco:report jacoco:check || echo "Coverage check completed"
    
    - name: Create Issues from Findings
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          // Check SpotBugs results
          if (fs.existsSync('target/spotbugsXml.xml')) {
            const xml = fs.readFileSync('target/spotbugsXml.xml', 'utf8');
            if (xml.includes('<BugInstance')) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: '[AUTO] SpotBugs found potential issues',
                body: 'SpotBugs analysis detected potential bugs. Check the workflow logs for details.',
                labels: ['bug', 'automated', 'spotbugs']
              });
            }
          }
          
          // Check PMD results
          if (fs.existsSync('target/pmd.xml')) {
            const xml = fs.readFileSync('target/pmd.xml', 'utf8');
            if (xml.includes('<violation')) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: '[AUTO] PMD found code quality issues',
                body: 'PMD analysis detected code quality violations. Check the workflow logs for details.',
                labels: ['code-quality', 'automated', 'pmd']
              });
            }
          }