name: Feature Branch Validation

on:
  push:
    branches: 
      - 'feature/**'
      - 'bugfix/**'
      - 'hotfix/**'
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened]

jobs:
  validate-feature:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
    
    - name: Cache Maven dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
    
    - name: Build and Test
      run: |
        mvn clean compile test-compile
        mvn test
    
    - name: Code Quality Checks
      run: |
        mvn spotbugs:spotbugs pmd:pmd
        
    - name: Security Vulnerability Check
      run: |
        mvn org.owasp:dependency-check-maven:check
    
    - name: Fail on Critical Issues
      run: |
        # Check for critical SpotBugs issues
        if [ -f "target/spotbugsXml.xml" ]; then
          if grep -q 'priority="1"' target/spotbugsXml.xml; then
            echo "‚ùå Critical SpotBugs issues found!"
            exit 1
          fi
        fi
        
        # Check for high priority PMD violations
        if [ -f "target/pmd.xml" ]; then
          if grep -q 'priority="1"' target/pmd.xml; then
            echo "‚ùå High priority PMD violations found!"
            exit 1
          fi
        fi
        
        echo "‚úÖ No critical issues found in feature branch"
    
    - name: Comment PR with Results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          let comment = '## üîç Feature Branch Validation Results\n\n';
          
          // Check SpotBugs
          if (fs.existsSync('target/spotbugsXml.xml')) {
            const xml = fs.readFileSync('target/spotbugsXml.xml', 'utf8');
            const bugCount = (xml.match(/<BugInstance/g) || []).length;
            comment += `- **SpotBugs**: ${bugCount} issues found\n`;
          }
          
          // Check PMD
          if (fs.existsSync('target/pmd.xml')) {
            const xml = fs.readFileSync('target/pmd.xml', 'utf8');
            const violationCount = (xml.match(/<violation/g) || []).length;
            comment += `- **PMD**: ${violationCount} violations found\n`;
          }
          
          comment += '\n‚úÖ Feature branch validation completed. Safe to merge if no critical issues above.';
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });