package com.cloudkitchen.rbac.service.impl;\n\nimport static org.junit.jupiter.api.Assertions.*;\nimport static org.mockito.Mockito.*;\n\nimport java.util.Optional;\n\nimport org.junit.jupiter.api.BeforeEach;\nimport org.junit.jupiter.api.Test;\nimport org.junit.jupiter.api.extension.ExtendWith;\nimport org.mockito.InjectMocks;\nimport org.mockito.Mock;\nimport org.mockito.junit.jupiter.MockitoExtension;\n\nimport com.cloudkitchen.rbac.dto.auth.AuthRequest;\nimport com.cloudkitchen.rbac.exception.BusinessExceptions.MobileNotRegisteredException;\nimport com.cloudkitchen.rbac.exception.BusinessExceptions.ValidationException;\nimport com.cloudkitchen.rbac.repository.UserRepository;\nimport com.cloudkitchen.rbac.service.ValidationService;\n\n/**\n * Test class to verify all 8 defects (D001-D008) are resolved\n * in the Customer Login API implementation.\n */\n@ExtendWith(MockitoExtension.class)\nclass CustomerLoginDefectVerificationTest {\n\n    @Mock\n    private UserRepository userRepository;\n    \n    @Mock\n    private ValidationService validationService;\n    \n    @InjectMocks\n    private AuthServiceImpl authService;\n    \n    private AuthRequest validRequest;\n    \n    @BeforeEach\n    void setUp() {\n        validRequest = new AuthRequest();\n        validRequest.setMerchantId(1);\n        validRequest.setUsername(\"9876543210\");\n        validRequest.setPassword(\"Test123!\");\n    }\n    \n    /**\n     * D001: FIXED - Mobile validation rejects invalid formats\n     * Expected: 400 \"Mobile number must be 10 digits\"\n     */\n    @Test\n    void testD001_MobileValidationRejectsInvalidFormats() {\n        // Test space in mobile\n        AuthRequest requestWithSpace = new AuthRequest();\n        requestWithSpace.setMerchantId(1);\n        requestWithSpace.setUsername(\"98765 43210\");\n        requestWithSpace.setPassword(\"Test123!\");\n        \n        doThrow(new IllegalArgumentException(\"Mobile number must be 10 digits\"))\n            .when(validationService).validateMobileForLogin(\"98765 43210\");\n        \n        ValidationException exception = assertThrows(ValidationException.class, \n            () -> authService.login(requestWithSpace));\n        assertEquals(\"Mobile number must be 10 digits\", exception.getMessage());\n        \n        // Test dash in mobile\n        AuthRequest requestWithDash = new AuthRequest();\n        requestWithDash.setMerchantId(1);\n        requestWithDash.setUsername(\"9876-543210\");\n        requestWithDash.setPassword(\"Test123!\");\n        \n        doThrow(new IllegalArgumentException(\"Mobile number must be 10 digits\"))\n            .when(validationService).validateMobileForLogin(\"9876-543210\");\n        \n        exception = assertThrows(ValidationException.class, \n            () -> authService.login(requestWithDash));\n        assertEquals(\"Mobile number must be 10 digits\", exception.getMessage());\n        \n        // Test alphabets in mobile\n        AuthRequest requestWithAlphabets = new AuthRequest();\n        requestWithAlphabets.setMerchantId(1);\n        requestWithAlphabets.setUsername(\"98765abc10\");\n        requestWithAlphabets.setPassword(\"Test123!\");\n        \n        doThrow(new IllegalArgumentException(\"Mobile number must be 10 digits\"))\n            .when(validationService).validateMobileForLogin(\"98765abc10\");\n        \n        exception = assertThrows(ValidationException.class, \n            () -> authService.login(requestWithAlphabets));\n        assertEquals(\"Mobile number must be 10 digits\", exception.getMessage());\n    }\n    \n    /**\n     * D002: FIXED - Input validation runs before business logic\n     * Expected: No DB calls for invalid input\n     */\n    @Test\n    void testD002_InputValidationRunsFirst() {\n        AuthRequest invalidRequest = new AuthRequest();\n        invalidRequest.setMerchantId(1);\n        invalidRequest.setUsername(\"invalid mobile\");\n        invalidRequest.setPassword(\"Test123!\");\n        \n        doThrow(new IllegalArgumentException(\"Mobile number must be 10 digits\"))\n            .when(validationService).validateMobileForLogin(\"invalid mobile\");\n        \n        assertThrows(ValidationException.class, () -> authService.login(invalidRequest));\n        \n        // Verify no DB calls were made\n        verify(userRepository, never()).findByPhoneAndMerchant_MerchantId(anyString(), anyInt());\n    }\n    \n    /**\n     * D003: FIXED - Specific error messages instead of generic ones\n     * Expected: Specific messages for each scenario\n     */\n    @Test\n    void testD003_SpecificErrorMessages() {\n        // Test missing mobile\n        AuthRequest noMobile = new AuthRequest();\n        noMobile.setMerchantId(1);\n        noMobile.setPassword(\"Test123!\");\n        \n        ValidationException exception = assertThrows(ValidationException.class, \n            () -> authService.login(noMobile));\n        assertEquals(\"Username is required\", exception.getMessage());\n        \n        // Test missing password\n        AuthRequest noPassword = new AuthRequest();\n        noPassword.setMerchantId(1);\n        noPassword.setUsername(\"9876543210\");\n        \n        exception = assertThrows(ValidationException.class, \n            () -> authService.login(noPassword));\n        assertEquals(\"Password is required\", exception.getMessage());\n    }\n    \n    /**\n     * D004: FIXED - No 500 errors for client mistakes\n     * Expected: All client errors return 4xx status codes\n     */\n    @Test\n    void testD004_No500ErrorsForClientMistakes() {\n        // Invalid input should throw ValidationException (400)\n        AuthRequest invalidRequest = new AuthRequest();\n        invalidRequest.setMerchantId(1);\n        invalidRequest.setUsername(\"invalid\");\n        invalidRequest.setPassword(\"Test123!\");\n        \n        doThrow(new IllegalArgumentException(\"Mobile number must be 10 digits\"))\n            .when(validationService).validateMobileForLogin(\"invalid\");\n        \n        assertThrows(ValidationException.class, () -> authService.login(invalidRequest));\n        \n        // Mobile not registered should throw MobileNotRegisteredException (404)\n        when(userRepository.findByPhoneAndMerchant_MerchantId(\"9876543210\", 1))\n            .thenReturn(Optional.empty());\n        \n        assertThrows(MobileNotRegisteredException.class, () -> authService.login(validRequest));\n    }\n    \n    /**\n     * D005: FIXED - Centralized mobile validation\n     * Expected: ValidationService.validateMobileForLogin() used\n     */\n    @Test\n    void testD005_CentralizedMobileValidation() {\n        doThrow(new IllegalArgumentException(\"Mobile number must be 10 digits\"))\n            .when(validationService).validateMobileForLogin(\"9876543210\");\n        \n        assertThrows(ValidationException.class, () -> authService.login(validRequest));\n        \n        // Verify centralized validation was called\n        verify(validationService).validateMobileForLogin(\"9876543210\");\n    }\n    \n    /**\n     * D006: FIXED - No framework validation messages\n     * Expected: Manual validation prevents framework messages\n     */\n    @Test\n    void testD006_NoFrameworkValidationMessages() {\n        // This is verified by removing @Valid annotations from controller\n        // and implementing manual validation in service layer\n        \n        // Test that our manual validation throws ValidationException\n        AuthRequest emptyRequest = new AuthRequest();\n        \n        ValidationException exception = assertThrows(ValidationException.class, \n            () -> authService.login(emptyRequest));\n        \n        // Our custom message, not framework message\n        assertTrue(exception.getMessage().contains(\"MerchantId is required\") ||\n                  exception.getMessage().contains(\"Username is required\") ||\n                  exception.getMessage().contains(\"Password is required\"));\n    }\n    \n    /**\n     * D007: FIXED - Thin controller, business logic in service\n     * Expected: Controller only handles HTTP concerns\n     */\n    @Test\n    void testD007_BusinessLogicInService() {\n        // This test verifies that validation logic is in service layer\n        // Controller should only handle HTTP status codes and delegate to service\n        \n        // Validation logic is now in AuthService.validateLoginInputs()\n        ValidationException exception = assertThrows(ValidationException.class, \n            () -> authService.login(new AuthRequest()));\n        \n        assertNotNull(exception.getMessage());\n    }\n    \n    /**\n     * D008: FIXED - Specific HTTP status codes\n     * Expected: Correct status codes handled by GlobalExceptionHandler\n     */\n    @Test\n    void testD008_SpecificHttpStatusCodes() {\n        // ValidationException should map to 400\n        assertThrows(ValidationException.class, () -> authService.login(new AuthRequest()));\n        \n        // MobileNotRegisteredException should map to 404\n        when(userRepository.findByPhoneAndMerchant_MerchantId(\"9876543210\", 1))\n            .thenReturn(Optional.empty());\n        \n        assertThrows(MobileNotRegisteredException.class, () -> authService.login(validRequest));\n    }\n    \n    /**\n     * Integration test: Valid mobile format but not registered\n     * Expected: 404 \"Mobile number not registered\"\n     */\n    @Test\n    void testValidFormatButNotRegistered() {\n        when(userRepository.findByPhoneAndMerchant_MerchantId(\"9876543210\", 1))\n            .thenReturn(Optional.empty());\n        \n        MobileNotRegisteredException exception = assertThrows(MobileNotRegisteredException.class, \n            () -> authService.login(validRequest));\n        \n        assertEquals(\"Mobile number not registered\", exception.getMessage());\n        \n        // Verify validation was called first\n        verify(validationService).validateMobileForLogin(\"9876543210\");\n    }\n}